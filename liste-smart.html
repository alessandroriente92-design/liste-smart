<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste Smart - Generatore Liste di Taglio</title>
    
    <!-- jsPDF per generazione PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 3px solid #667eea;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            background: #f5f5f5;
            border: none;
            transition: all 0.3s;
            font-size: 16px;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
            margin-bottom: -3px;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .section-header h2 {
            color: #667eea;
            font-size: 1.8em;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-inline {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 14px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-info {
            background: #17a2b8;
            color: white;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .material-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .material-item:hover {
            background: #e9ecef;
        }

        .material-name {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .component-row {
            display: grid;
            grid-template-columns: 120px 200px 120px 120px 100px 200px 140px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .component-row.fixed {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .component-row select,
        .component-row input {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
        }

        .btn-fixed {
            padding: 8px 12px;
            border: 2px solid #ffc107;
            background: white;
            color: #856404;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-fixed:hover {
            background: #ffc107;
            color: white;
        }

        .btn-fixed.active {
            background: #ffc107;
            color: white;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .project-info {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .project-info h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state svg {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .summary-card h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; gap: 20px;">
                <div style="flex: 0 0 auto;">
                    <h1 style="margin: 0; font-size: 2em;">üìã Liste Smart</h1>
                </div>
                <div style="flex: 1; display: flex; align-items: center; gap: 10px; justify-content: center;">
                    <span style="font-weight: bold; color: white;">Progetto:</span>
                    <select id="projectSelector" onchange="switchProject()" style="padding: 8px 12px; border-radius: 5px; border: none; font-size: 14px; min-width: 200px; font-weight: bold;">
                        <option value="">Seleziona progetto...</option>
                    </select>
                    <button onclick="saveCurrentProject()" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px;">
                        üíæ Salva
                    </button>
                </div>
                <div style="flex: 0 0 auto; text-align: right;">
                    <button onclick="createNewProject()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: all 0.3s; margin-right: 10px;">
                        ‚ûï Nuovo Progetto
                    </button>
                    <button onclick="deleteCurrentProject()" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: all 0.3s;">
                        üóëÔ∏è Elimina Progetto
                    </button>
                </div>
            </div>
            <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 0.9em;">Generatore Automatico di Liste di Taglio per Controtelai</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">üé® Materiali</button>
            <button class="tab" onclick="switchTab(1)">üìê Progetto</button>
            <button class="tab" onclick="switchTab(2)">üìù Template</button>
            <button class="tab" onclick="switchTab(3)">‚ö° Genera Liste</button>
            <button class="tab" onclick="switchTab(4)">üîê Validazioni</button>
            <button class="tab" onclick="switchTab(5)">‚öôÔ∏è Impostazioni</button>
        </div>

        <!-- TAB 1: MATERIALI -->
        <div class="tab-content active">
            <div class="section">
                <div class="section-header">
                    <h2>Gestione Materiali</h2>
                </div>
                
                <div class="alert alert-info">
                    <strong>üí° Info:</strong> Aggiungi qui tutti i materiali che utilizzi. La lunghezza massima serve per splittare automaticamente i pezzi troppo lunghi durante la generazione del CSV.
                </div>

                <div class="form-inline">
                    <div class="form-group">
                        <label>Nome Materiale</label>
                        <input type="text" id="materialName" placeholder="es. MULTISTRATO 18mm">
                    </div>
                    <div class="form-group">
                        <label>Lunghezza Max (mm)</label>
                        <input type="number" id="materialMaxLength" placeholder="2800" value="2800" style="width: 150px;">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" onclick="addMaterial()">‚ûï Aggiungi Materiale</button>
                    </div>
                </div>

                <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">üìÅ Importa/Esporta Materiali</h3>
                    <div class="btn-group">
                        <label class="btn btn-success" style="cursor: pointer; margin: 0;">
                            üì• Importa da CSV
                            <input type="file" id="csvImport" accept=".csv,.txt" style="display: none;" onchange="importMaterialsCSV(event)">
                        </label>
                        <button class="btn btn-primary" onclick="exportMaterialsCSV()">üì§ Esporta CSV</button>
                    </div>
                    <p style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                        <strong>Formato CSV:</strong> MATERIALE;LUNGHEZZA_MAX (es: MULTISTRATO 18mm;2500)
                    </p>
                </div>

                <div id="materialsList" style="margin-top: 30px;"></div>
            </div>
        </div>

        <!-- TAB 2: PROGETTO -->
        <div class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Setup Progetto</h2>
                </div>

                <div class="project-info">
                    <div class="form-inline">
                        <div class="form-group">
                            <label>Nome Commessa</label>
                            <input type="text" id="projectName" placeholder="es. IAQUINTA">
                        </div>
                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" id="projectDate">
                        </div>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>üí° Info:</strong> Inserisci tutte le posizioni del progetto con le relative misure. Queste saranno usate per generare le liste.
                </div>

                <button class="btn btn-success" onclick="addPosition()" style="margin-bottom: 20px;">‚ûï Aggiungi Posizione</button>

                <table id="positionsTable">
                    <thead>
                        <tr>
                            <th>POS</th>
                            <th>NPZ</th>
                            <th>L (mm)</th>
                            <th>H (mm)</th>
                            <th>Note</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="positionsBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TAB 3: TEMPLATE -->
        <div class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Template Modelli</h2>
                    <button class="btn btn-primary" onclick="startNewTemplate()">‚ûï Nuovo Template</button>
                </div>

                <div id="templatesList"></div>

                <div id="templateEditor" style="display: none;">
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Compilazione Template:</strong> Le LARGHEZZE sono sempre fisse. Le LUNGHEZZE variano in base al TIPO (H/DH = altezza, C/L/D/SB = larghezza, TAPPO = fisso). 
                        <br><strong>üîí Componente Fisso:</strong> Clicca sul pulsante "Blocca" per marcare un componente come fisso - le sue misure resteranno identiche in tutte le repliche, indipendentemente dal TIPO.
                        <br><strong>üìè Distanziali (D):</strong> Il sistema rileva automaticamente se sono pezzi SINGOLI o FILE da 2. Se la quantit√† nel template segue la regola base (‚â§900mm=1, 901-1500=2, 1501-2400=3, 2401-2800=4, >2800=5) ‚Üí pezzi singoli. Altrimenti ‚Üí file da 2 distanziali.
                    </div>

                    <div class="project-info">
                        <h3>Informazioni Template</h3>
                        <div class="form-inline">
                            <div class="form-group">
                                <label>Posizione</label>
                                <select id="templatePos">
                                    <option value="">Seleziona...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Riferimento Misure</label>
                                <input type="text" id="templateRefMisure" readonly>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Repliche (seleziona le posizioni da replicare)</label>
                            <div id="replicheCheckboxes" class="checkbox-group"></div>
                        </div>
                    </div>

                    <!-- Tab interni: Componenti e Quote Cliente -->
                    <div style="display: flex; gap: 10px; margin: 20px 0; border-bottom: 2px solid #667eea;">
                        <button id="tabComponenti" class="template-tab active" onclick="switchTemplateTab('componenti')" style="padding: 10px 20px; border: none; background: transparent; cursor: pointer; font-weight: bold; color: #667eea; border-bottom: 3px solid #667eea;">
                            üì¶ Componenti
                        </button>
                        <button id="tabQuoteCliente" class="template-tab" onclick="switchTemplateTab('quote')" style="padding: 10px 20px; border: none; background: transparent; cursor: pointer; font-weight: bold; color: #999; border-bottom: 3px solid transparent;">
                            üìê Quote Cliente
                        </button>
                    </div>

                    <!-- Sezione Componenti -->
                    <div id="sectionComponenti" class="template-section">
                        <div style="margin: 20px 0;">
                            <div class="btn-group" style="flex-wrap: wrap; gap: 10px;">
                                <button class="btn btn-success" onclick="addComponent()">‚ûï Aggiungi Componente</button>
                                <label class="btn btn-primary" style="cursor: pointer; margin: 0;">
                                    üì• Carica da CSV
                                    <input type="file" id="csvComponentsImport" accept=".csv,.txt" style="display: none;" onchange="importComponentsCSV(event)">
                                </label>
                                <div style="display: flex; gap: 5px; align-items: center; background: #e8f5e9; padding: 8px 12px; border-radius: 8px; border: 2px solid #4caf50;">
                                    <span style="font-weight: bold; color: #2e7d32; font-size: 14px;">üîß ISP:</span>
                                    <input type="number" id="ispLunghezza" placeholder="L" style="padding: 6px; border: 1px solid #4caf50; border-radius: 4px; width: 70px; font-size: 14px;">
                                    <input type="number" id="ispAltezza" value="240" placeholder="H" style="padding: 6px; border: 1px solid #4caf50; border-radius: 4px; width: 70px; font-size: 14px;">
                                    <button onclick="generateISPFrontale()" style="background: #4caf50; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px;">
                                        ‚ö° Genera
                                    </button>
                                </div>
                            </div>
                            <p style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                                <strong>Formato CSV:</strong> TIPO;NOME;LARGHEZZA;LUNGHEZZA;QUANTITA';MATERIALE
                            </p>
                        </div>

                        <div style="margin-bottom: 10px; font-weight: bold; display: grid; grid-template-columns: 120px 200px 120px 120px 100px 200px 140px; gap: 10px; padding: 0 10px;">
                            <div>TIPO</div>
                            <div>NOME</div>
                            <div>LARGHEZZA</div>
                            <div>LUNGHEZZA</div>
                            <div>QUANTIT√Ä</div>
                            <div>MATERIALE</div>
                            <div>AZIONI</div>
                        </div>

                        <div id="componentsEditor"></div>
                    </div>

                    <!-- Sezione Quote Cliente -->
                    <div id="sectionQuoteCliente" class="template-section" style="display: none;">
                        <div class="alert alert-info" style="margin-bottom: 20px;">
                            <strong>üí° Info:</strong> Aggiungi qui le misure che verranno fornite al cliente nel documento PDF finale. Puoi inserire qualsiasi tipo di misura (es: Misura luce, Misura esterna, Misura tapparelle, ecc.)
                        </div>

                        <!-- Descrizione generale -->
                        <div style="margin-bottom: 20px; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #856404;">üìù Descrizione (apparir√† nel PDF dopo il numero posizione)</label>
                            <textarea id="quoteDescrizione" placeholder="es: Finestra principale soggiorno, porta-finestra cucina, ecc." style="width: 100%; padding: 10px; border: 2px solid #ffc107; border-radius: 5px; min-height: 60px; font-family: inherit;" onchange="updateQuoteDescrizione()"></textarea>
                        </div>

                        <div style="display: flex; gap: 10px; align-items: end; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div style="flex: 2;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Tipo Misura</label>
                                <input type="text" id="quotaTipo" placeholder="es: Misura luce" style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 5px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Larghezza (L)</label>
                                <input type="number" id="quotaL" placeholder="mm" style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 5px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Altezza (H)</label>
                                <input type="number" id="quotaH" placeholder="mm (opzionale)" style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 5px;">
                            </div>
                            <button class="btn btn-success" onclick="addQuota()" style="padding: 10px 20px;">‚ûï Aggiungi</button>
                        </div>

                        <div id="quoteEditor"></div>
                    </div>

                    <div class="btn-group" style="margin-top: 30px;">
                        <button class="btn btn-success" onclick="saveTemplate()">üíæ Salva Template</button>
                        <button class="btn btn-secondary" onclick="cancelTemplate()">‚ùå Annulla</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: GENERA LISTE -->
        <div class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Genera Liste di Taglio</h2>
                </div>

                <div id="generateSection"></div>
            </div>
        </div>

        <!-- TAB 5: VALIDAZIONI -->
        <div class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>üîê Validazioni Misure Cliente</h2>
                </div>

                <div class="alert alert-info" style="margin-bottom: 20px;">
                    <strong>üí° Come funziona:</strong><br>
                    1. Genera un link per il cliente<br>
                    2. Il cliente inserisce le sue misure (senza vedere le tue)<br>
                    3. Il sistema controlla automaticamente quando conferma<br>
                    4. Generi il PDF validato con confronto misure
                </div>

                <button class="btn btn-success" onclick="createValidation()" style="font-size: 16px; padding: 15px 30px; margin-bottom: 30px;">
                    ‚ûï Nuova Validazione Progetto Corrente
                </button>

                <div id="validationsList"></div>
            </div>
        </div>

        <!-- TAB 6: IMPOSTAZIONI -->
        <div class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>‚öôÔ∏è Impostazioni</h2>
                </div>

                <div class="alert alert-info" style="margin-bottom: 20px;">
                    <strong>üí° Setup JSONBin.io:</strong><br>
                    1. Vai su <a href="https://jsonbin.io" target="_blank">jsonbin.io</a> e registrati (gratuito)<br>
                    2. Dashboard ‚Üí API Keys ‚Üí Copia la "Master Key"<br>
                    3. Incolla qui sotto e salva
                </div>

                <div style="max-width: 600px;">
                    <div class="form-group">
                        <label style="font-weight: bold; font-size: 16px;">JSONBin.io API Key</label>
                        <input type="text" id="jsonbinApiKey" placeholder="$2a$10$..." style="width: 100%; padding: 12px; font-family: monospace; margin-top: 10px;">
                    </div>
                    
                    <button class="btn btn-success" onclick="saveApiKey()" style="margin-top: 15px; padding: 12px 24px;">
                        üíæ Salva API Key
                    </button>

                    <div id="apiKeyStatus" style="margin-top: 15px;"></div>

                    <div style="margin-top: 30px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px;">
                        <strong>üîí Privacy:</strong> La tua API Key √® salvata solo nel tuo browser (localStorage). Non viene mai inviata a terzi.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dati globali
        let materials = [];  // GLOBALE - condiviso tra tutti i progetti
        let projects = [];   // Array di tutti i progetti
        let currentProjectId = null;  // ID del progetto corrente
        
        // Dati del progetto corrente (caricati dal progetto selezionato)
        let positions = [];
        let templates = [];
        let currentTemplate = null;
        let editingTemplateIndex = -1;
        
        // Validazioni
        let validations = [];  // Array di validazioni
        let validationCheckInterval = null;  // Interval per auto-refresh

        // Carica dati salvati
        function loadData() {
            const saved = localStorage.getItem('listeSmart');
            if (saved) {
                const data = JSON.parse(saved);
                
                // Migrazione dati: converti vecchi materiali (stringhe) in nuovi materiali (oggetti)
                if (data.materials && data.materials.length > 0) {
                    if (typeof data.materials[0] === 'string') {
                        // Vecchio formato: array di stringhe
                        materials = data.materials.map(nome => ({
                            nome: nome,
                            lunghezzaMax: 2800  // Default per materiali vecchi
                        }));
                    } else {
                        // Nuovo formato: array di oggetti
                        materials = data.materials;
                    }
                } else {
                    materials = [];
                }
                
                // Carica progetti
                if (data.projects && Array.isArray(data.projects)) {
                    // Nuovo formato multi-progetto
                    projects = data.projects;
                    currentProjectId = data.currentProjectId || null;
                    
                    // Carica il progetto corrente
                    if (currentProjectId) {
                        loadProject(currentProjectId);
                    } else if (projects.length > 0) {
                        // Carica il primo progetto se non c'√® un progetto corrente
                        currentProjectId = projects[0].id;
                        loadProject(currentProjectId);
                    }
                } else {
                    // Migrazione da vecchio formato (senza progetti)
                    // Crea un progetto dalla vecchia struttura
                    if (data.positions || data.templates) {
                        const migratedProject = {
                            id: 'project_' + Date.now(),
                            nome: data.projectName || 'Progetto Migrato',
                            data: data.projectDate || new Date().toISOString().split('T')[0],
                            positions: data.positions || [],
                            templates: data.templates || [],
                            dataUltimaModifica: new Date().toISOString()
                        };
                        projects = [migratedProject];
                        currentProjectId = migratedProject.id;
                        loadProject(currentProjectId);
                    } else {
                        // Nessun dato, inizializza vuoto
                        projects = [];
                        currentProjectId = null;
                        positions = [];
                        templates = [];
                    }
                }
            }
            
            renderProjectSelector();
            renderMaterials();
            renderPositions();
            renderTemplates();
            updateGenerateSection();
        }

        // Salva dati
        function saveData() {
            // Salva automaticamente il progetto corrente se esiste
            if (currentProjectId) {
                const project = projects.find(p => p.id === currentProjectId);
                if (project) {
                    project.nome = document.getElementById('projectName').value || 'Progetto Senza Nome';
                    project.data = document.getElementById('projectDate').value;
                    project.positions = [...positions];
                    project.templates = [...templates];
                    project.dataUltimaModifica = new Date().toISOString();
                }
            }
            
            const data = {
                materials,  // Globale
                projects,   // Tutti i progetti
                currentProjectId  // Progetto attualmente selezionato
            };
            localStorage.setItem('listeSmart', JSON.stringify(data));
        }

        // === GESTIONE MULTI-PROGETTO ===
        
        function renderProjectSelector() {
            const selector = document.getElementById('projectSelector');
            
            if (projects.length === 0) {
                selector.innerHTML = '<option value="">Nessun progetto - Crea il primo!</option>';
                selector.disabled = true;
                return;
            }
            
            selector.disabled = false;
            selector.innerHTML = projects.map(p => {
                const selected = p.id === currentProjectId ? 'selected' : '';
                const dataModifica = new Date(p.dataUltimaModifica).toLocaleDateString('it-IT');
                return `<option value="${p.id}" ${selected}>${p.nome} (${dataModifica})</option>`;
            }).join('');
        }
        
        function loadProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                console.error('Progetto non trovato:', projectId);
                return;
            }
            
            currentProjectId = projectId;
            positions = project.positions || [];
            templates = project.templates || [];
            
            document.getElementById('projectName').value = project.nome || '';
            document.getElementById('projectDate').value = project.data || '';
            
            // Refresh interfaccia
            renderProjectSelector();
            renderPositions();
            renderTemplates();
            updateGenerateSection();
        }
        
        function saveCurrentProject() {
            if (!currentProjectId) {
                alert('‚ö†Ô∏è Nessun progetto selezionato!');
                return;
            }
            
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) {
                alert('‚ùå Errore: progetto non trovato!');
                return;
            }
            
            saveData();
            renderProjectSelector();
            
            alert('‚úÖ Progetto salvato con successo!');
        }
        
        function createNewProject() {
            // Salva il progetto corrente prima di creare uno nuovo
            if (currentProjectId) {
                saveData();
            }
            
            const nome = prompt('Nome del nuovo progetto:', 'Nuova Commessa');
            if (!nome) return;
            
            const newProject = {
                id: 'project_' + Date.now(),
                nome: nome,
                data: new Date().toISOString().split('T')[0],
                positions: [],
                templates: [],
                dataUltimaModifica: new Date().toISOString()
            };
            
            projects.push(newProject);
            currentProjectId = newProject.id;
            
            loadProject(currentProjectId);
            saveData();
            
            // Vai al tab Progetto per iniziare
            switchTab(1);
            
            alert(`‚úÖ Progetto "${nome}" creato!\n\nPuoi iniziare ad aggiungere posizioni.`);
        }
        
        function switchProject() {
            const selector = document.getElementById('projectSelector');
            const newProjectId = selector.value;
            
            if (!newProjectId || newProjectId === currentProjectId) {
                return;
            }
            
            // Salva il progetto corrente prima di cambiare
            if (currentProjectId) {
                saveData();
            }
            
            // Carica il nuovo progetto
            loadProject(newProjectId);
        }
        
        function deleteCurrentProject() {
            if (!currentProjectId) {
                alert('‚ö†Ô∏è Nessun progetto selezionato!');
                return;
            }
            
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) {
                alert('‚ùå Errore: progetto non trovato!');
                return;
            }
            
            const confirmed = confirm(
                `‚ö†Ô∏è ATTENZIONE!\n\n` +
                `Stai per ELIMINARE il progetto:\n\n` +
                `"${project.nome}"\n\n` +
                `Tutte le posizioni e i template di questo progetto verranno cancellati definitivamente.\n\n` +
                `I MATERIALI verranno conservati.\n\n` +
                `Sei sicuro di voler continuare?`
            );
            
            if (!confirmed) return;
            
            // Rimuovi il progetto dall'array
            projects = projects.filter(p => p.id !== currentProjectId);
            
            // Carica un altro progetto o resetta
            if (projects.length > 0) {
                currentProjectId = projects[0].id;
                loadProject(currentProjectId);
            } else {
                currentProjectId = null;
                positions = [];
                templates = [];
                document.getElementById('projectName').value = '';
                document.getElementById('projectDate').value = new Date().toISOString().split('T')[0];
                renderPositions();
                renderTemplates();
                updateGenerateSection();
            }
            
            saveData();
            renderProjectSelector();
            
            alert('‚úÖ Progetto eliminato!');
        }

        // Switch tab
        function switchTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                    contents[i].classList.add('active');
                } else {
                    tab.classList.remove('active');
                    contents[i].classList.remove('active');
                }
            });

            if (index === 3) {
                updateGenerateSection();
            } else if (index === 4) {
                // TAB Validazioni - avvia auto-refresh
                renderValidations();
                startValidationsAutoRefresh();
            } else if (index === 5) {
                // TAB Impostazioni - carica API key
                const apiKey = getApiKey();
                if (apiKey) {
                    document.getElementById('jsonbinApiKey').value = apiKey;
                }
            } else {
                // Altri tab - ferma auto-refresh
                stopValidationsAutoRefresh();
            }
        }

        // === MATERIALI ===
        function addMaterial() {
            const name = document.getElementById('materialName').value.trim();
            const maxLength = parseInt(document.getElementById('materialMaxLength').value) || 2800;
            
            if (!name) {
                alert('Inserisci il nome del materiale');
                return;
            }
            
            // Controlla se il materiale esiste gi√†
            if (materials.some(m => m.nome === name)) {
                alert('Materiale gi√† presente');
                return;
            }
            
            materials.push({ nome: name, lunghezzaMax: maxLength });
            document.getElementById('materialName').value = '';
            document.getElementById('materialMaxLength').value = '2800';
            saveData();
            renderMaterials();
        }

        function importMaterialsCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split(/\r?\n/).map(line => line.trim()).filter(line => line);
                
                // Rimuovi eventuale intestazione
                const startIndex = lines[0].toLowerCase().includes('materiale') ? 1 : 0;
                
                let added = 0;
                let skipped = 0;
                
                for (let i = startIndex; i < lines.length; i++) {
                    const parts = lines[i].split(';');
                    const nome = parts[0].trim();
                    const lunghezzaMax = parts.length > 1 ? parseInt(parts[1]) : 2800;
                    
                    if (nome && !materials.some(m => m.nome === nome)) {
                        materials.push({ nome, lunghezzaMax });
                        added++;
                    } else if (materials.some(m => m.nome === nome)) {
                        skipped++;
                    }
                }
                
                saveData();
                renderMaterials();
                
                alert(`‚úÖ Importazione completata!\n\nAggiunti: ${added}\nGi√† presenti (saltati): ${skipped}`);
                
                // Reset input file
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function exportMaterialsCSV() {
            if (materials.length === 0) {
                alert('Non ci sono materiali da esportare');
                return;
            }

            let csv = 'MATERIALE;LUNGHEZZA_MAX\n';
            materials.forEach(mat => {
                csv += `${mat.nome};${mat.lunghezzaMax}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'materiali.csv';
            link.click();

            alert('‚úÖ CSV materiali esportato con successo!');
        }

        function deleteMaterial(index) {
            if (confirm('Sei sicuro di voler eliminare questo materiale?')) {
                materials.splice(index, 1);
                saveData();
                renderMaterials();
            }
        }

        function renderMaterials() {
            const list = document.getElementById('materialsList');
            if (materials.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>Nessun materiale</h3>
                        <p>Aggiungi i materiali che utilizzi per i tuoi controtelai</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = materials.map((mat, i) => `
                <div class="material-item">
                    <span class="material-name">${mat.nome} <span style="color: #667eea; font-weight: bold;">(Max: ${mat.lunghezzaMax}mm)</span></span>
                    <button class="btn btn-danger" onclick="deleteMaterial(${i})">üóëÔ∏è Elimina</button>
                </div>
            `).join('');
        }

        // === POSIZIONI ===
        function addPosition() {
            if (!currentProjectId) {
                alert('‚ö†Ô∏è Nessun progetto selezionato!\n\nCrea o seleziona un progetto prima di aggiungere posizioni.');
                return;
            }
            
            const nextPosNum = positions.length + 1;
            positions.push({
                pos: `POS ${nextPosNum}`,
                npz: 1,
                l: '',
                h: '',
                note: ''
            });
            saveData();
            renderPositions();
        }

        function deletePosition(index) {
            if (confirm('Sei sicuro di voler eliminare questa posizione?')) {
                positions.splice(index, 1);
                saveData();
                renderPositions();
            }
        }

        function updatePosition(index, field, value) {
            positions[index][field] = value;
            saveData();
        }

        function renderPositions() {
            const tbody = document.getElementById('positionsBody');
            if (positions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            <div class="empty-state">
                                <h3>Nessuna posizione</h3>
                                <p>Aggiungi le posizioni del progetto</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = positions.map((pos, i) => `
                <tr>
                    <td><input type="text" value="${pos.pos}" onchange="updatePosition(${i}, 'pos', this.value)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                    <td><input type="number" value="${pos.npz}" onchange="updatePosition(${i}, 'npz', this.value)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                    <td><input type="number" value="${pos.l}" onchange="updatePosition(${i}, 'l', this.value)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                    <td><input type="number" value="${pos.h}" onchange="updatePosition(${i}, 'h', this.value)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                    <td><input type="text" value="${pos.note}" onchange="updatePosition(${i}, 'note', this.value)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></td>
                    <td><button class="btn btn-danger" onclick="deletePosition(${i})">üóëÔ∏è</button></td>
                </tr>
            `).join('');
        }

        // === TEMPLATE ===
        function getOccupiedPositions(excludeTemplateIndex = -1) {
            const occupied = new Set();
            
            templates.forEach((tmpl, index) => {
                // Non considerare il template che stiamo editando
                if (index === excludeTemplateIndex) return;
                
                // Aggiungi la posizione master
                occupied.add(tmpl.pos);
                
                // Aggiungi tutte le repliche
                tmpl.repliche.forEach(rep => occupied.add(rep));
            });
            
            return occupied;
        }

        function startNewTemplate() {
            if (!currentProjectId) {
                alert('‚ö†Ô∏è Nessun progetto selezionato!\n\nCrea o seleziona un progetto prima di creare template.');
                return;
            }
            
            if (positions.length === 0) {
                alert('Devi prima aggiungere almeno una posizione nella sezione Progetto!');
                switchTab(1);
                return;
            }

            const occupied = getOccupiedPositions();
            const availablePositions = positions.filter(p => !occupied.has(p.pos));
            
            if (availablePositions.length === 0) {
                alert('‚ö†Ô∏è Tutte le posizioni sono gi√† assegnate a dei template!\n\nPer creare un nuovo template devi prima aggiungere nuove posizioni nella sezione Progetto.');
                return;
            }

            document.getElementById('templatesList').style.display = 'none';
            document.getElementById('templateEditor').style.display = 'block';
            
            currentTemplate = {
                pos: '',
                refL: '',
                refH: '',
                repliche: [],
                components: [],
                quote: [],  // Quote cliente
                descrizioneCliente: ''  // Descrizione per il PDF cliente
            };
            editingTemplateIndex = -1;

            // Popola select solo con posizioni libere
            const select = document.getElementById('templatePos');
            select.innerHTML = '<option value="">Seleziona...</option>' + 
                availablePositions.map((p, i) => {
                    const originalIndex = positions.indexOf(p);
                    return `<option value="${originalIndex}">${p.pos}</option>`;
                }).join('');
            
            document.getElementById('templateRefMisure').value = '';
            renderReplicheCheckboxes();
            renderComponentsEditor();
            renderQuoteEditor();
        }

        function editTemplate(index) {
            const template = templates[index];
            editingTemplateIndex = index;
            currentTemplate = JSON.parse(JSON.stringify(template));

            document.getElementById('templatesList').style.display = 'none';
            document.getElementById('templateEditor').style.display = 'block';

            const occupied = getOccupiedPositions(index);
            const availablePositions = positions.filter(p => !occupied.has(p.pos));

            // Popola select includendo la posizione corrente del template
            const select = document.getElementById('templatePos');
            select.innerHTML = '<option value="">Seleziona...</option>' + 
                positions
                    .filter(p => p.pos === template.pos || !occupied.has(p.pos))
                    .map(p => {
                        const originalIndex = positions.indexOf(p);
                        return `<option value="${originalIndex}">${p.pos}</option>`;
                    }).join('');
            
            const posIndex = positions.findIndex(p => p.pos === template.pos);
            if (posIndex >= 0) {
                select.value = posIndex;
                updateTemplateRefMisure();
            }

            renderReplicheCheckboxes();
            renderComponentsEditor();
            renderQuoteEditor();
        }

        function deleteTemplate(index) {
            if (confirm('Sei sicuro di voler eliminare questo template?')) {
                templates.splice(index, 1);
                saveData();
                renderTemplates();
            }
        }

        function updateTemplateRefMisure() {
            const select = document.getElementById('templatePos');
            const posIndex = parseInt(select.value);
            
            if (posIndex >= 0 && positions[posIndex]) {
                const pos = positions[posIndex];
                currentTemplate.pos = pos.pos;
                currentTemplate.refL = pos.l;
                currentTemplate.refH = pos.h;
                document.getElementById('templateRefMisure').value = `L ${pos.l} x H ${pos.h}`;
                
                // Aggiorna i nomi di tutti i componenti esistenti
                currentTemplate.components.forEach(comp => {
                    comp.nome = `${comp.tipo} ${pos.pos}`;
                });
                renderComponentsEditor();
            }
            renderReplicheCheckboxes();
        }

        function renderReplicheCheckboxes() {
            const container = document.getElementById('replicheCheckboxes');
            const currentPos = document.getElementById('templatePos').value;
            
            if (!currentPos) {
                container.innerHTML = '<p style="color: #6c757d;">Seleziona prima una posizione</p>';
                return;
            }

            const posIndex = parseInt(currentPos);
            const occupied = getOccupiedPositions(editingTemplateIndex);
            
            // Filtra posizioni: escludi quella corrente e quelle occupate
            // Ma includi le repliche gi√† esistenti nel template corrente
            const availablePositions = positions.filter((p, i) => {
                if (i === posIndex) return false; // Escludi posizione master corrente
                if (currentTemplate.repliche.includes(p.pos)) return true; // Includi repliche gi√† esistenti
                return !occupied.has(p.pos); // Escludi posizioni occupate
            });

            if (availablePositions.length === 0) {
                container.innerHTML = '<p style="color: #6c757d;">Nessuna posizione disponibile per la replica. Tutte le altre posizioni sono gi√† assegnate.</p>';
                return;
            }

            container.innerHTML = availablePositions.map(p => {
                const checked = currentTemplate.repliche.includes(p.pos) ? 'checked' : '';
                const actualIndex = positions.indexOf(p);
                return `
                    <div class="checkbox-item">
                        <input type="checkbox" id="rep_${actualIndex}" ${checked} onchange="toggleReplica('${p.pos}')">
                        <label for="rep_${actualIndex}">${p.pos}</label>
                    </div>
                `;
            }).join('');
        }

        function toggleReplica(posName) {
            const index = currentTemplate.repliche.indexOf(posName);
            if (index >= 0) {
                currentTemplate.repliche.splice(index, 1);
            } else {
                currentTemplate.repliche.push(posName);
            }
        }

        function addComponent() {
            const tipo = 'H';
            const nome = currentTemplate.pos ? `${tipo} ${currentTemplate.pos}` : '';
            
            currentTemplate.components.push({
                tipo: tipo,
                nome: nome,
                larghezza: '',
                lunghezza: '',
                quantita: 1,
                materiale: (materials[0] && materials[0].nome) || '',
                fisso: false
            });
            renderComponentsEditor();
        }

        function importComponentsCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!currentTemplate.pos) {
                alert('‚ö†Ô∏è Seleziona prima una posizione per il template!\n\nIl sistema deve sapere quale posizione usare per auto-compilare i nomi dei componenti.');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split(/\r?\n/).map(line => line.trim()).filter(line => line);
                
                // Rimuovi eventuale intestazione
                const startIndex = lines[0].toUpperCase().includes('TIPO') ? 1 : 0;
                
                let added = 0;
                let errors = [];
                
                for (let i = startIndex; i < lines.length; i++) {
                    const parts = lines[i].split(';').map(p => p.trim());
                    
                    // Verifica che ci siano almeno 6 campi
                    if (parts.length < 6) {
                        errors.push(`Riga ${i + 1}: formato non valido (${parts.length} campi invece di 6)`);
                        continue;
                    }
                    
                    const [tipo, nome, larghezza, lunghezza, quantita, materiale] = parts;
                    
                    // Valida TIPO
                    const tipiValidi = ['H', 'DH', 'C', 'L', 'D', 'SB', 'TAPPO'];
                    if (!tipiValidi.includes(tipo)) {
                        errors.push(`Riga ${i + 1}: TIPO "${tipo}" non valido (usa: ${tipiValidi.join(', ')})`);
                        continue;
                    }
                    
                    // Aggiungi componente
                    currentTemplate.components.push({
                        tipo: tipo,
                        nome: nome || `${tipo} ${currentTemplate.pos}`,
                        larghezza: larghezza || '',
                        lunghezza: lunghezza || '',
                        quantita: quantita || 1,
                        materiale: materiale || ((materials[0] && materials[0].nome) || ''),
                        fisso: false
                    });
                    added++;
                }
                
                renderComponentsEditor();
                
                let message = `‚úÖ Importazione completata!\n\nComponenti aggiunti: ${added}`;
                if (errors.length > 0) {
                    message += `\n\nErrori (${errors.length}):\n${errors.slice(0, 5).join('\n')}`;
                    if (errors.length > 5) {
                        message += `\n... e altri ${errors.length - 5} errori`;
                    }
                }
                
                alert(message);
                
                // Reset input file
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function generateISPFrontale() {
            const L = parseFloat(document.getElementById('ispLunghezza').value);
            const H = parseFloat(document.getElementById('ispAltezza').value);

            if (!L || L <= 0) {
                alert('‚ö†Ô∏è Inserisci una lunghezza telaio valida!');
                return;
            }

            if (!H || H <= 0) {
                alert('‚ö†Ô∏è Inserisci un\'altezza telaio valida!');
                return;
            }

            if (!currentTemplate.pos) {
                alert('‚ö†Ô∏è Seleziona prima una posizione per il template!');
                return;
            }

            // Genera i 7 componenti del sistema ISP frontale
            const componentiISP = [
                {
                    tipo: 'C',
                    nome: `C ISP ${currentTemplate.pos}`,
                    larghezza: 30,
                    lunghezza: L,
                    quantita: 2,
                    materiale: 'E41064',
                    fisso: false
                },
                {
                    tipo: 'C',
                    nome: `C ISP ${currentTemplate.pos}`,
                    larghezza: 30,
                    lunghezza: H,
                    quantita: 2,
                    materiale: 'E41064',
                    fisso: true  // 2¬∞ componente BLOCCATO
                },
                {
                    tipo: 'C',
                    nome: `C ISP ${currentTemplate.pos}`,
                    larghezza: H - 64,
                    lunghezza: L - 54,
                    quantita: 1,
                    materiale: 'MDF 12mm',
                    fisso: false
                },
                {
                    tipo: 'C',
                    nome: `C ISP ${currentTemplate.pos}`,
                    larghezza: (H - 64) - 30,
                    lunghezza: L - 54,
                    quantita: 1,
                    materiale: 'MDF 4mm',
                    fisso: false
                },
                {
                    tipo: 'C',
                    nome: `C ISP ${currentTemplate.pos}`,
                    larghezza: H - 35,
                    lunghezza: L - 32,
                    quantita: 1,
                    materiale: 'PVC 10mm',
                    fisso: false
                },
                {
                    tipo: 'C',
                    nome: `C ISP ${currentTemplate.pos}`,
                    larghezza: 25,
                    lunghezza: L,
                    quantita: 2,
                    materiale: 'RETE 5mm',
                    fisso: false
                },
                {
                    tipo: 'C',
                    nome: `C ISP ${currentTemplate.pos}`,
                    larghezza: 25,
                    lunghezza: H - 48,
                    quantita: 2,
                    materiale: 'RETE 5mm',
                    fisso: true  // 7¬∞ componente BLOCCATO
                }
            ];

            // Aggiungi tutti i componenti
            componentiISP.forEach(comp => {
                currentTemplate.components.push(comp);
            });

            // Aggiorna l'interfaccia
            renderComponentsEditor();

            // Reset campi
            document.getElementById('ispLunghezza').value = '';
            document.getElementById('ispAltezza').value = '240';

            alert(`‚úÖ Sistema ISP Frontale generato!\n\n7 componenti aggiunti per telaio L=${L} √ó H=${H}`);
        }

        function deleteComponent(index) {
            currentTemplate.components.splice(index, 1);
            renderComponentsEditor();
        }

        function toggleFixed(index) {
            currentTemplate.components[index].fisso = !currentTemplate.components[index].fisso;
            renderComponentsEditor();
        }

        function updateComponent(index, field, value) {
            currentTemplate.components[index][field] = value;
            
            // Auto-compila NOME quando cambia il TIPO
            if (field === 'tipo' && currentTemplate.pos) {
                const tipo = value;
                const posName = currentTemplate.pos;
                currentTemplate.components[index].nome = `${tipo} ${posName}`;
                renderComponentsEditor();
            }
        }

        function renderComponentsEditor() {
            const container = document.getElementById('componentsEditor');
            
            if (currentTemplate.components.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Nessun componente. Clicca "Aggiungi Componente" per iniziare.</p>
                    </div>
                `;
                return;
            }

            const materialOptions = materials.map(m => `<option value="${m.nome}">${m.nome}</option>`).join('');

            container.innerHTML = currentTemplate.components.map((comp, i) => `
                <div class="component-row ${comp.fisso ? 'fixed' : ''}">
                    <select onchange="updateComponent(${i}, 'tipo', this.value)">
                        <option value="H" ${comp.tipo === 'H' ? 'selected' : ''}>H</option>
                        <option value="DH" ${comp.tipo === 'DH' ? 'selected' : ''}>DH</option>
                        <option value="C" ${comp.tipo === 'C' ? 'selected' : ''}>C</option>
                        <option value="L" ${comp.tipo === 'L' ? 'selected' : ''}>L</option>
                        <option value="D" ${comp.tipo === 'D' ? 'selected' : ''}>D</option>
                        <option value="SB" ${comp.tipo === 'SB' ? 'selected' : ''}>SB</option>
                        <option value="TAPPO" ${comp.tipo === 'TAPPO' ? 'selected' : ''}>TAPPO</option>
                    </select>
                    <input type="text" placeholder="Nome" value="${comp.nome || ''}" onchange="updateComponent(${i}, 'nome', this.value)">
                    <input type="number" placeholder="Largh." value="${comp.larghezza || ''}" onchange="updateComponent(${i}, 'larghezza', this.value)">
                    <input type="number" placeholder="Lungh." value="${comp.lunghezza || ''}" onchange="updateComponent(${i}, 'lunghezza', this.value)">
                    <input type="number" placeholder="Qt√†" value="${comp.quantita || ''}" onchange="updateComponent(${i}, 'quantita', this.value)">
                    <select onchange="updateComponent(${i}, 'materiale', this.value)">
                        ${materialOptions}
                    </select>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn-fixed ${comp.fisso ? 'active' : ''}" onclick="toggleFixed(${i})" title="${comp.fisso ? 'Componente bloccato (misure fisse)' : 'Clicca per bloccare (misure fisse)'}">
                            ${comp.fisso ? 'üîí FISSO' : 'üîì Blocca'}
                        </button>
                        <button class="btn btn-danger" onclick="deleteComponent(${i})" style="padding: 8px 12px;">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            // Set selected materials
            currentTemplate.components.forEach((comp, i) => {
                const row = container.children[i];
                if (row) {
                    row.querySelector('select:last-of-type').value = comp.materiale;
                }
            });
        }

        // === TAB INTERNI TEMPLATE ===
        function switchTemplateTab(tab) {
            // Aggiorna stili tab
            document.getElementById('tabComponenti').style.color = tab === 'componenti' ? '#667eea' : '#999';
            document.getElementById('tabComponenti').style.borderBottom = tab === 'componenti' ? '3px solid #667eea' : '3px solid transparent';
            document.getElementById('tabQuoteCliente').style.color = tab === 'quote' ? '#667eea' : '#999';
            document.getElementById('tabQuoteCliente').style.borderBottom = tab === 'quote' ? '3px solid #667eea' : '3px solid transparent';
            
            // Mostra/nascondi sezioni
            document.getElementById('sectionComponenti').style.display = tab === 'componenti' ? 'block' : 'none';
            document.getElementById('sectionQuoteCliente').style.display = tab === 'quote' ? 'block' : 'none';
        }

        // === GESTIONE QUOTE CLIENTE ===
        function updateQuoteDescrizione() {
            currentTemplate.descrizioneCliente = document.getElementById('quoteDescrizione').value;
        }

        function addQuota() {
            const tipo = document.getElementById('quotaTipo').value.trim();
            const L = document.getElementById('quotaL').value;
            const H = document.getElementById('quotaH').value;

            if (!tipo) {
                alert('‚ö†Ô∏è Inserisci il tipo di misura (es: Misura luce)');
                return;
            }

            if (!L) {
                alert('‚ö†Ô∏è Inserisci almeno la larghezza (L)');
                return;
            }

            if (!currentTemplate.quote) {
                currentTemplate.quote = [];
            }

            currentTemplate.quote.push({
                tipo: tipo,
                L: parseFloat(L) || 0,
                H: parseFloat(H) || 0
            });

            // Reset campi
            document.getElementById('quotaTipo').value = '';
            document.getElementById('quotaL').value = '';
            document.getElementById('quotaH').value = '';

            renderQuoteEditor();
        }

        function deleteQuota(index) {
            if (confirm('Sei sicuro di voler eliminare questa quota?')) {
                currentTemplate.quote.splice(index, 1);
                renderQuoteEditor();
            }
        }

        function renderQuoteEditor() {
            // Carica la descrizione nel campo textarea
            document.getElementById('quoteDescrizione').value = currentTemplate.descrizioneCliente || '';
            
            const container = document.getElementById('quoteEditor');

            if (!currentTemplate.quote || currentTemplate.quote.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Nessuna quota cliente. Clicca "Aggiungi" per iniziare.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = currentTemplate.quote.map((q, i) => {
                const misura = q.H > 0 ? `L ${q.L} √ó H ${q.H}` : `L ${q.L}`;
                return `
                    <div class="material-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>
                            <strong style="color: #667eea;">${q.tipo}:</strong> 
                            <span style="font-size: 16px;">${misura} mm</span>
                        </span>
                        <button class="btn btn-danger" onclick="deleteQuota(${i})">üóëÔ∏è Elimina</button>
                    </div>
                `;
            }).join('');
        }

        function saveTemplate() {
            if (!currentTemplate.pos) {
                alert('Seleziona una posizione per il template');
                return;
            }

            if (currentTemplate.components.length === 0) {
                alert('Aggiungi almeno un componente');
                return;
            }

            // Valida componenti
            for (let comp of currentTemplate.components) {
                if (!comp.nome || !comp.larghezza || !comp.lunghezza || !comp.quantita || !comp.materiale) {
                    alert('Compila tutti i campi dei componenti');
                    return;
                }
            }

            if (editingTemplateIndex >= 0) {
                templates[editingTemplateIndex] = currentTemplate;
            } else {
                templates.push(currentTemplate);
            }

            saveData();
            cancelTemplate();
            renderTemplates();
        }

        function cancelTemplate() {
            document.getElementById('templatesList').style.display = 'block';
            document.getElementById('templateEditor').style.display = 'none';
            currentTemplate = null;
            editingTemplateIndex = -1;
        }

        function renderTemplates() {
            const container = document.getElementById('templatesList');
            
            if (templates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Nessun template</h3>
                        <p>Crea il primo template per iniziare a generare le liste</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = templates.map((tmpl, i) => `
                <div class="material-item" style="display: block; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h3 style="color: #667eea; margin-bottom: 10px;">${tmpl.pos}</h3>
                            <p style="margin-bottom: 5px;"><strong>Ref Misure:</strong> L ${tmpl.refL} x H ${tmpl.refH}</p>
                            <p style="margin-bottom: 5px;"><strong>Componenti:</strong> ${tmpl.components.length}</p>
                            <p><strong>Repliche:</strong> ${tmpl.repliche.length > 0 ? tmpl.repliche.join(', ') : 'Nessuna'}</p>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="editTemplate(${i})">‚úèÔ∏è Modifica</button>
                            <button class="btn btn-danger" onclick="deleteTemplate(${i})">üóëÔ∏è Elimina</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // === GENERA LISTE ===
        function updateGenerateSection() {
            const section = document.getElementById('generateSection');

            if (templates.length === 0 || positions.length === 0) {
                section.innerHTML = `
                    <div class="empty-state">
                        <h3>Dati incompleti</h3>
                        <p>Completa le sezioni Progetto e Template per generare le liste</p>
                    </div>
                `;
                return;
            }

            const projectName = document.getElementById('projectName').value || 'Progetto';

            section.innerHTML = `
                <div class="summary-card">
                    <h3>üìä Riepilogo Progetto: ${projectName}</h3>
                    <div class="summary-item">
                        <span>Posizioni totali:</span>
                        <strong>${positions.length}</strong>
                    </div>
                    <div class="summary-item">
                        <span>Template creati:</span>
                        <strong>${templates.length}</strong>
                    </div>
                    <div class="summary-item">
                        <span>Materiali disponibili:</span>
                        <strong>${materials.length}</strong>
                    </div>
                </div>

                <div class="alert alert-success">
                    <strong>‚úÖ Pronto per generare!</strong> Clicca i pulsanti qui sotto per generare i documenti.
                </div>

                <div class="btn-group" style="gap: 20px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="generateCSV()" style="font-size: 18px; padding: 20px 40px; flex: 1; min-width: 300px;">
                        üöÄ GENERA CSV LISTE DI TAGLIO
                    </button>
                    <button class="btn btn-primary" onclick="generateDocumentoCliente()" style="font-size: 18px; padding: 20px 40px; flex: 1; min-width: 300px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        üìÑ GENERA DOCUMENTO CLIENTE PDF
                    </button>
                </div>
            `;
        }

        function generateCSV() {
            // Genera tutte le liste
            let allRows = [];

            templates.forEach(template => {
                // Template principale
                const templatePos = positions.find(p => p.pos === template.pos);
                if (templatePos) {
                    allRows = allRows.concat(generateRowsForPosition(template, templatePos, template));
                }

                // Repliche
                template.repliche.forEach(replicaPos => {
                    const pos = positions.find(p => p.pos === replicaPos);
                    if (pos) {
                        allRows = allRows.concat(generateRowsForPosition(template, pos, template));
                    }
                });
            });

            // Crea CSV
            let csv = 'TIPO;NOME;LARGHEZZA;LUNGHEZZA;QUANTITA\';MATERIALE\n';
            allRows.forEach(row => {
                csv += `${row.tipo};${row.nome};${row.larghezza};${row.lunghezza};${row.quantita};${row.materiale}\n`;
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const projectName = document.getElementById('projectName').value || 'progetto';
            link.href = URL.createObjectURL(blob);
            link.download = `LISTA_TAGLIO_${projectName}.csv`;
            link.click();

            alert('‚úÖ CSV generato con successo!');
        }

        function generateDocumentoCliente() {
            // Raccogli tutte le quote e descrizioni da tutti i template con repliche
            const datiPerPosizione = {}; // {pos: {descrizione: '', quote: [], template: {}}}
            
            templates.forEach(template => {
                if (!template.quote || template.quote.length === 0) {
                    return; // Salta template senza quote
                }
                
                // Template principale
                if (!datiPerPosizione[template.pos]) {
                    datiPerPosizione[template.pos] = {
                        descrizione: template.descrizioneCliente || '',
                        quote: [...template.quote],
                        refL: parseFloat(template.refL) || 0,
                        refH: parseFloat(template.refH) || 0
                    };
                }
                
                // Repliche
                template.repliche.forEach(replicaPos => {
                    if (!datiPerPosizione[replicaPos]) {
                        datiPerPosizione[replicaPos] = {
                            descrizione: template.descrizioneCliente || '',
                            quote: [...template.quote],
                            refL: parseFloat(template.refL) || 0,
                            refH: parseFloat(template.refH) || 0
                        };
                    }
                });
            });
            
            if (Object.keys(datiPerPosizione).length === 0) {
                alert('‚ö†Ô∏è Nessuna quota cliente trovata!\n\nAggiungi le quote nei template (tab "Quote Cliente") prima di generare il documento.');
                return;
            }
            
            // Prepara i dati per il PDF
            const projectName = document.getElementById('projectName').value || 'Progetto';
            const projectDate = document.getElementById('projectDate').value || new Date().toISOString().split('T')[0];
            
            // Filtra solo le posizioni che hanno quote
            const posizioniConQuote = positions.filter(pos => datiPerPosizione[pos.pos]);
            
            if (posizioniConQuote.length === 0) {
                alert('‚ö†Ô∏è Nessuna posizione con quote trovata!');
                return;
            }
            
            // Ricalcola le quote per ogni posizione in base alle sue misure
            posizioniConQuote.forEach(pos => {
                const dati = datiPerPosizione[pos.pos];
                const posL = parseFloat(pos.l) || 0;
                const posH = parseFloat(pos.h) || 0;
                const refL = dati.refL;
                const refH = dati.refH;
                
                // Ricalcola ogni quota
                dati.quoteRicalcolate = dati.quote.map(q => {
                    let newL = q.L;
                    let newH = q.H;
                    
                    // Se la quota ha una larghezza, calcola l'offset
                    if (q.L > 0 && refL > 0) {
                        const offsetL = q.L - refL;
                        newL = posL + offsetL;
                    }
                    
                    // Se la quota ha un'altezza, calcola l'offset
                    if (q.H > 0 && refH > 0) {
                        const offsetH = q.H - refH;
                        newH = posH + offsetH;
                    }
                    
                    return {
                        tipo: q.tipo,
                        L: Math.round(newL),
                        H: Math.round(newH)
                    };
                });
            });
            
            // Crea il PDF con jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Colori
            const primaryColor = [102, 126, 234]; // #667eea
            const textColor = [50, 50, 50];
            const greyColor = [150, 150, 150];
            const yellowColor = [255, 193, 7]; // #ffc107
            
            let yPosition = 20;
            
            // Intestazione
            doc.setFontSize(24);
            doc.setTextColor(...primaryColor);
            doc.text('DOCUMENTO MISURE CLIENTE', doc.internal.pageSize.width / 2, yPosition, { align: 'center' });
            
            yPosition += 10;
            doc.setFontSize(12);
            doc.setTextColor(...greyColor);
            doc.text(`Commessa: ${projectName} | Data: ${projectDate}`, doc.internal.pageSize.width / 2, yPosition, { align: 'center' });
            
            yPosition += 15;
            
            // Per ogni posizione con quote
            posizioniConQuote.forEach((pos, index) => {
                const dati = datiPerPosizione[pos.pos];
                const quote = dati.quoteRicalcolate; // Usa le quote RICALCOLATE
                const descrizione = dati.descrizione;
                
                // Controlla se serve una nuova pagina
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Titolo posizione
                doc.setFontSize(16);
                doc.setTextColor(...primaryColor);
                let posTitle = pos.pos;
                if (pos.npz > 1) {
                    posTitle += ` | Numero Pezzi: ${pos.npz}`;
                }
                doc.text(posTitle, 15, yPosition);
                yPosition += 7;
                
                // Descrizione cliente (dopo il numero posizione)
                if (descrizione && descrizione.trim()) {
                    doc.setFontSize(12);
                    doc.setTextColor(...textColor);
                    doc.setFont(undefined, 'bold');
                    
                    // Gestione testo lungo con wrapping
                    const maxWidth = doc.internal.pageSize.width - 30; // margini 15+15
                    const lines = doc.splitTextToSize(descrizione, maxWidth);
                    
                    lines.forEach(line => {
                        doc.text(line, 15, yPosition);
                        yPosition += 5;
                    });
                    
                    doc.setFont(undefined, 'normal');
                    yPosition += 2;
                }
                
                // Note se presenti
                if (pos.note && pos.note.trim()) {
                    doc.setFontSize(10);
                    doc.setTextColor(...greyColor);
                    doc.setFont(undefined, 'italic');
                    doc.text(`Note: ${pos.note}`, 15, yPosition);
                    doc.setFont(undefined, 'normal');
                    yPosition += 5;
                }
                
                // Prepara dati tabella con le quote RICALCOLATE
                const tableData = quote.map(q => {
                    return [
                        q.tipo,
                        q.L > 0 ? q.L.toString() : '-',
                        q.H > 0 ? q.H.toString() : '-'
                    ];
                });
                
                // Genera tabella
                doc.autoTable({
                    startY: yPosition,
                    head: [['Tipo Misura', 'Larghezza (mm)', 'Altezza (mm)']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: {
                        fillColor: primaryColor,
                        textColor: [255, 255, 255],
                        fontSize: 11,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    bodyStyles: {
                        fontSize: 10,
                        halign: 'center',
                        textColor: textColor
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    margin: { left: 15, right: 15 }
                });
                
                yPosition = doc.lastAutoTable.finalY + 12;
            });
            
            // Footer su ogni pagina
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(9);
                doc.setTextColor(...greyColor);
                const footerText = `Documento generato da Liste Smart | ${new Date().toLocaleDateString('it-IT')} ${new Date().toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}`;
                doc.text(footerText, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
            }
            
            // Salva PDF
            const fileName = `DOCUMENTO_CLIENTE_${projectName.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
            doc.save(fileName);
            
            alert('‚úÖ Documento Cliente PDF generato con successo!');
        }

        function generateRowsForPosition(template, position, originalTemplate) {
            const rows = [];
            const npz = parseInt(position.npz) || 1;
            const posL = parseFloat(position.l) || 0;
            const posH = parseFloat(position.h) || 0;
            const refL = parseFloat(originalTemplate.refL) || 0;
            const refH = parseFloat(originalTemplate.refH) || 0;

            template.components.forEach(comp => {
                let lunghezza = parseFloat(comp.lunghezza);

                // Se il componente √® fisso, non ricalcolare la lunghezza
                if (!comp.fisso) {
                    // Calcola lunghezza in base al tipo
                    if (comp.tipo === 'TAPPO') {
                        // Tappo: lunghezza fissa (gi√† impostata)
                    } else if (comp.tipo === 'H' || comp.tipo === 'DH') {
                        // Dipende da H
                        const offset = lunghezza - refH;
                        lunghezza = posH + offset;
                    } else if (comp.tipo === 'C' || comp.tipo === 'L' || comp.tipo === 'D' || comp.tipo === 'SB') {
                        // Dipende da L
                        const offset = lunghezza - refL;
                        lunghezza = posL + offset;
                    }
                }

                // Calcola quantit√†
                let quantita = parseInt(comp.quantita);
                
                // Per i distanziali (tipo D), calcola quantit√† in base all'altezza
                if (comp.tipo === 'D' && !comp.fisso) {
                    // Calcola quanti distanziali servirebbero per l'altezza del TEMPLATE secondo la regola base
                    let quantitaBaseTemplate;
                    if (refH <= 900) quantitaBaseTemplate = 1;
                    else if (refH <= 1500) quantitaBaseTemplate = 2;
                    else if (refH <= 2400) quantitaBaseTemplate = 3;
                    else if (refH <= 2800) quantitaBaseTemplate = 4;
                    else quantitaBaseTemplate = 5;
                    
                    // Se la quantit√† nel template corrisponde alla regola base ‚Üí sono pezzi SINGOLI
                    // Altrimenti sono FILE da 2
                    const sonoPezziSingoli = (quantita === quantitaBaseTemplate);
                    
                    // Calcola quanti file/pezzi servono per la nuova altezza
                    let numeroFileOPezzi;
                    if (posH <= 900) numeroFileOPezzi = 1;
                    else if (posH <= 1500) numeroFileOPezzi = 2;
                    else if (posH <= 2400) numeroFileOPezzi = 3;
                    else if (posH <= 2800) numeroFileOPezzi = 4;
                    else numeroFileOPezzi = 5;
                    
                    // Applica la logica
                    if (sonoPezziSingoli) {
                        // Pezzi singoli
                        quantita = numeroFileOPezzi;
                    } else {
                        // File da 2 distanziali
                        quantita = numeroFileOPezzi * 2;
                    }
                }

                // Trova la lunghezza massima del materiale
                const materialObj = materials.find(m => m.nome === comp.materiale);
                const lunghezzaMax = materialObj ? materialObj.lunghezzaMax : 9999;
                const lunghezzaFinale = Math.round(lunghezza);

                // Se la lunghezza supera il massimo, splitta in 2 pezzi
                if (lunghezzaFinale > lunghezzaMax) {
                    const pezzo1 = lunghezzaMax - 50;
                    const pezzo2 = lunghezzaFinale - pezzo1;
                    
                    // Riga 1: pezzo lungo (max - 50mm)
                    rows.push({
                        tipo: 'Input Panel',
                        nome: `${comp.tipo} ${position.pos} (1/2)`,
                        larghezza: comp.larghezza,
                        lunghezza: pezzo1,
                        quantita: quantita * npz,
                        materiale: comp.materiale
                    });
                    
                    // Riga 2: pezzo corto (differenza)
                    rows.push({
                        tipo: 'Input Panel',
                        nome: `${comp.tipo} ${position.pos} (2/2)`,
                        larghezza: comp.larghezza,
                        lunghezza: pezzo2,
                        quantita: quantita * npz,
                        materiale: comp.materiale
                    });
                } else {
                    // Pezzo normale (non supera il massimo)
                    rows.push({
                        tipo: 'Input Panel',
                        nome: `${comp.tipo} ${position.pos}`,
                        larghezza: comp.larghezza,
                        lunghezza: lunghezzaFinale,
                        quantita: quantita * npz,
                        materiale: comp.materiale
                    });
                }
            });

            return rows;
        }

        // === GESTIONE API KEY ===
        function saveApiKey() {
            const apiKey = document.getElementById('jsonbinApiKey').value.trim();
            if (!apiKey) {
                alert('‚ö†Ô∏è Inserisci la tua API Key di JSONBin.io');
                return;
            }
            
            localStorage.setItem('jsonbinApiKey', apiKey);
            document.getElementById('apiKeyStatus').innerHTML = `
                <div style="padding: 12px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; color: #155724;">
                    ‚úÖ API Key salvata con successo!
                </div>
            `;
        }

        function getApiKey() {
            return localStorage.getItem('jsonbinApiKey');
        }

        // === GESTIONE VALIDAZIONI ===
        async function createValidation() {
            if (!currentProjectId) {
                alert('‚ö†Ô∏è Seleziona un progetto prima di creare una validazione!');
                return;
            }

            const apiKey = getApiKey();
            if (!apiKey) {
                alert('‚ö†Ô∏è Configura prima la tua API Key nelle Impostazioni!');
                switchTab(5);
                return;
            }

            // Raccogli i template master (non repliche)
            const masterTemplates = templates.filter(t => t.quote && t.quote.length > 0);
            
            if (masterTemplates.length === 0) {
                alert('‚ö†Ô∏è Nessun template con quote trovato!\n\nAggiungi le quote nei template prima di creare una validazione.');
                return;
            }

            const projectName = document.getElementById('projectName').value || 'Progetto';
            const projectDate = document.getElementById('projectDate').value || new Date().toISOString().split('T')[0];

            // Prepara dati validazione
            const validationData = {
                projectName: projectName,
                projectDate: projectDate,
                generatedAt: new Date().toISOString(),
                status: 'pending',
                confirmedAt: null,
                apiKey: apiKey,  // Salva API key nel bin per permettere aggiornamenti
                templates: masterTemplates.map(t => ({
                    pos: t.pos,
                    descrizione: t.descrizioneCliente || '',
                    refL: t.refL,
                    refH: t.refH,
                    yourQuotes: t.quote.map(q => ({tipo: q.tipo, L: q.L, H: q.H})),
                    clientQuotes: null
                }))
            };

            // Salva su JSONBin.io
            try {
                const response = await fetch('https://api.jsonbin.io/v3/b', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': apiKey,
                        'X-Bin-Private': 'false'  // Rende il bin pubblicamente leggibile
                    },
                    body: JSON.stringify(validationData)
                });

                if (!response.ok) {
                    throw new Error('Errore durante la creazione della validazione');
                }

                const result = await response.json();
                const binId = result.metadata.id;

                // Salva validazione localmente
                const validation = {
                    id: binId,
                    projectName: projectName,
                    projectId: currentProjectId,
                    generatedAt: validationData.generatedAt,
                    status: 'pending',
                    confirmedAt: null
                };

                validations.push(validation);
                saveValidationsData();
                renderValidations();

                alert(`‚úÖ Validazione creata con successo!\n\nInvia il link al cliente.\nIl sistema controller√† automaticamente ogni 30 secondi.`);

            } catch (error) {
                console.error('Errore:', error);
                alert('‚ùå Errore durante la creazione della validazione.\n\nVerifica la tua API Key nelle Impostazioni.');
            }
        }

        function saveValidationsData() {
            localStorage.setItem('validations', JSON.stringify(validations));
        }

        function loadValidationsData() {
            const saved = localStorage.getItem('validations');
            if (saved) {
                validations = JSON.parse(saved);
            }
        }

        async function checkValidationStatus(validationId) {
            const apiKey = getApiKey();
            if (!apiKey) return null;

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${validationId}`, {
                    headers: {
                        'X-Master-Key': apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error('Errore durante il controllo stato');
                }

                const result = await response.json();
                return result.record;

            } catch (error) {
                console.error('Errore check status:', error);
                return null;
            }
        }

        async function checkAllPendingValidations() {
            const pending = validations.filter(v => v.status === 'pending');
            
            for (const validation of pending) {
                const data = await checkValidationStatus(validation.id);
                if (data && data.status === 'confirmed') {
                    // Aggiorna status locale
                    validation.status = 'confirmed';
                    validation.confirmedAt = data.confirmedAt;
                    saveValidationsData();
                    
                    // Mostra notifica
                    alert(`üîî Il cliente ha confermato le misure per: ${validation.projectName}!`);
                }
            }
            
            renderValidations();
        }

        function renderValidations() {
            const container = document.getElementById('validationsList');
            
            if (validations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Nessuna validazione</h3>
                        <p>Crea una nuova validazione per iniziare</p>
                    </div>
                `;
                return;
            }

            // Separa pending e confirmed
            const pending = validations.filter(v => v.status === 'pending');
            const confirmed = validations.filter(v => v.status === 'confirmed');

            let html = '';

            if (pending.length > 0) {
                html += '<h3 style="color: #ffc107; margin-bottom: 20px;">‚è≥ IN ATTESA CONFERMA CLIENTE</h3>';
                pending.forEach(v => {
                    // Genera URL assoluto completo
                    const currentUrl = window.location.href.split('?')[0]; // Rimuove parametri
                    const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1); // Prende la directory
                    const linkUrl = baseUrl + `validazione-cliente.html?id=${v.id}`;
                    
                    html += `
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; margin-bottom: 20px; border-radius: 5px;">
                            <h4 style="margin: 0 0 10px 0; color: #856404;">üìã ${v.projectName}</h4>
                            <p style="margin: 5px 0; color: #856404;"><strong>Generato:</strong> ${new Date(v.generatedAt).toLocaleString('it-IT')}</p>
                            <p style="margin: 5px 0; color: #856404;"><strong>Status:</strong> ‚è≥ In attesa cliente</p>
                            
                            <div style="margin: 15px 0; padding: 15px; background: white; border-radius: 5px;">
                                <p style="margin: 0 0 10px 0; color: #856404; font-weight: bold;">üîó LINK PER IL CLIENTE:</p>
                                <input type="text" value="${linkUrl}" readonly onclick="this.select()" style="width: 100%; padding: 10px; font-size: 13px; font-family: monospace; background: white; border: 2px solid #667eea; border-radius: 5px; margin-bottom: 10px; cursor: pointer;">
                                <button class="btn btn-primary" onclick="copyValidationLink('${linkUrl}')" style="width: 100%;">üìã Copia Link Completo</button>
                                <p style="margin: 10px 0 0 0; color: #28a745; font-size: 13px;">‚úÖ Link completo pronto per WhatsApp/Email!</p>
                            </div>
                            
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="manualCheckStatus('${v.id}')">üîÑ Controlla Stato</button>
                                <button class="btn btn-danger" onclick="deleteValidation('${v.id}')">üóëÔ∏è Elimina</button>
                            </div>
                        </div>
                    `;
                });
            }

            if (confirmed.length > 0) {
                html += '<h3 style="color: #28a745; margin: 30px 0 20px 0;">‚úÖ CONFERMATE DAL CLIENTE</h3>';
                confirmed.forEach(v => {
                    html += `
                        <div style="background: #d4edda; border-left: 4px solid #28a745; padding: 20px; margin-bottom: 20px; border-radius: 5px;">
                            <h4 style="margin: 0 0 10px 0; color: #155724;">üìã ${v.projectName}</h4>
                            <p style="margin: 5px 0; color: #155724;"><strong>Generato:</strong> ${new Date(v.generatedAt).toLocaleString('it-IT')}</p>
                            <p style="margin: 5px 0; color: #155724;"><strong>Confermato:</strong> ${new Date(v.confirmedAt).toLocaleString('it-IT')}</p>
                            <div style="margin-top: 15px;" class="btn-group">
                                <button class="btn btn-success" onclick="generateValidatedPDF('${v.id}')">üìÑ Genera PDF Validato</button>
                                <button class="btn btn-danger" onclick="deleteValidation('${v.id}')">üóëÔ∏è Elimina</button>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function copyValidationLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('‚úÖ Link copiato negli appunti!\n\nInvialo al cliente via WhatsApp/Email.');
            }).catch(() => {
                prompt('Copia questo link:', link);
            });
        }

        function copyValidationId(id) {
            navigator.clipboard.writeText(id).then(() => {
                alert('‚úÖ ID copiato negli appunti!\n\nORA:\n1. Invia il file "validazione-cliente.html" al cliente\n2. Invia questo ID\n3. Il cliente aprir√† il file e inserir√† l\'ID');
            }).catch(() => {
                prompt('Copia questo ID:', id);
            });
        }

        async function manualCheckStatus(validationId) {
            const data = await checkValidationStatus(validationId);
            if (!data) {
                alert('‚ùå Errore durante il controllo dello stato.');
                return;
            }

            if (data.status === 'confirmed') {
                // Aggiorna locale
                const validation = validations.find(v => v.id === validationId);
                if (validation) {
                    validation.status = 'confirmed';
                    validation.confirmedAt = data.confirmedAt;
                    saveValidationsData();
                    renderValidations();
                }
                alert('‚úÖ Il cliente ha confermato le misure!');
            } else {
                alert('‚è≥ Il cliente non ha ancora confermato le misure.');
            }
        }

        async function generateValidatedPDF(validationId) {
            const apiKey = getApiKey();
            if (!apiKey) {
                alert('‚ö†Ô∏è API Key non configurata!');
                return;
            }

            try {
                // Scarica dati validazione da JSONBin
                const response = await fetch(`https://api.jsonbin.io/v3/b/${validationId}`, {
                    headers: {
                        'X-Master-Key': apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error('Errore nel caricamento dati validazione');
                }

                const result = await response.json();
                const validationData = result.record;

                if (validationData.status !== 'confirmed') {
                    alert('‚ö†Ô∏è Il cliente non ha ancora confermato le misure!');
                    return;
                }

                // Trova posizioni nel progetto corrente per ottenere le misure reali
                const projectPositions = positions; // Array delle posizioni del progetto

                // Crea il PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Colori
                const primaryColor = [102, 126, 234];
                const redColor = [220, 20, 60]; // Rosso Alpha Block Lab
                const greenColor = [40, 167, 69];
                const textColor = [50, 50, 50];
                const greyColor = [150, 150, 150];

                let yPosition = 15;

                // === INTESTAZIONE CON LOGO E DATI AZIENDALI ===
                
                // Logo Alpha Block Lab (base64 - versione semplificata)
                // Nota: Il logo verr√† aggiunto come immagine
                doc.setFontSize(18);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'bold');
                doc.text('ALPHA', 15, yPosition);
                doc.setTextColor(...greyColor);
                doc.text('BLOCK', 15, yPosition + 6);
                doc.setTextColor(...redColor);
                doc.text('LAB', 15, yPosition + 12);
                
                // Tagline
                doc.setFontSize(7);
                doc.setTextColor(...redColor);
                doc.setFont(undefined, 'bold');
                doc.text('MONOBLOCCHI TERMICI SU MISURA', 15, yPosition + 16);

                // Dati aziendali a destra
                doc.setFontSize(9);
                doc.setTextColor(...textColor);
                doc.setFont(undefined, 'bold');
                doc.text('ALPHA SHOWROOM S.A.S.', 200, yPosition, { align: 'right' });
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                doc.setTextColor(...greyColor);
                doc.text('P.IVA 03289110789', 200, yPosition + 5, { align: 'right' });
                doc.text('C/da Laise 46', 200, yPosition + 9, { align: 'right' });
                doc.text('Belvedere Marittimo (CS)', 200, yPosition + 13, { align: 'right' });

                // Linea separazione
                yPosition += 22;
                doc.setDrawColor(...greyColor);
                doc.setLineWidth(0.5);
                doc.line(10, yPosition, 200, yPosition);

                yPosition += 10;

                // === TITOLO REPORT ===
                doc.setFontSize(20);
                doc.setTextColor(...primaryColor);
                doc.setFont(undefined, 'bold');
                doc.text('REPORT MISURE', doc.internal.pageSize.width / 2, yPosition, { align: 'center' });

                yPosition += 7;
                doc.setFontSize(10);
                doc.setTextColor(...greyColor);
                doc.setFont(undefined, 'normal');
                doc.text(`Commessa: ${validationData.projectName} | Data: ${validationData.projectDate}`, doc.internal.pageSize.width / 2, yPosition, { align: 'center' });

                yPosition += 5;
                doc.setFontSize(9);
                doc.text(`Confermato il: ${new Date(validationData.confirmedAt).toLocaleDateString('it-IT')} alle ${new Date(validationData.confirmedAt).toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}`, doc.internal.pageSize.width / 2, yPosition, { align: 'center' });

                yPosition += 10;

                // DISCLAIMER LEGALE - Versione compatta
                doc.setFillColor(255, 243, 205);
                doc.rect(10, yPosition, doc.internal.pageSize.width - 20, 18, 'F');
                doc.setDrawColor(255, 193, 7);
                doc.setLineWidth(0.3);
                doc.rect(10, yPosition, doc.internal.pageSize.width - 20, 18, 'S');

                yPosition += 5;
                doc.setFontSize(7);
                doc.setTextColor(133, 100, 4);
                doc.setFont(undefined, 'bold');
                doc.text('‚ö† NOTA IMPORTANTE:', 13, yPosition);
                doc.setFont(undefined, 'normal');
                
                yPosition += 3;
                const disclaimerLines = [
                    'La tolleranza di precisione pu√≤ variare in base alle norme vigenti. Le misure sono di progetto e verranno verificate in produzione.',
                    'Non ci assumiamo responsabilit√† per deformazioni dovute al trasporto o alla posa del telaio.'
                ];
                
                disclaimerLines.forEach(line => {
                    const wrappedLines = doc.splitTextToSize(line, doc.internal.pageSize.width - 26);
                    wrappedLines.forEach(wLine => {
                        doc.text(wLine, 13, yPosition);
                        yPosition += 3;
                    });
                });

                yPosition += 8;

                // Per ogni template master
                validationData.templates.forEach((template, index) => {
                    // Trova la posizione corrispondente nel progetto
                    const position = projectPositions.find(p => p.pos === template.pos);
                    
                    if (!position) return; // Salta se posizione non trovata

                    // PRIMA: Determina quali misure sono DA VERIFICARE nel MASTER
                    const masterValidationStatus = {};
                    
                    const masterPosL = parseFloat(position.l) || 0;
                    const masterPosH = parseFloat(position.h) || 0;
                    const refL = parseFloat(template.refL) || 0;
                    const refH = parseFloat(template.refH) || 0;

                    template.yourQuotes.forEach((yourQuote, qIndex) => {
                        const clientQuote = template.clientQuotes[qIndex];

                        // Ricalcola le tue misure per il MASTER
                        let yourL = yourQuote.L;
                        let yourH = yourQuote.H;

                        if (yourQuote.L > 0 && refL > 0) {
                            const offsetL = yourQuote.L - refL;
                            yourL = masterPosL + offsetL;
                        }

                        if (yourQuote.H > 0 && refH > 0) {
                            const offsetH = yourQuote.H - refH;
                            yourH = masterPosH + offsetH;
                        }

                        yourL = Math.round(yourL);
                        yourH = Math.round(yourH);

                        // Confronta con cliente per determinare status
                        const isValidL = yourL > 0 ? (yourL === clientQuote.L) : true;
                        const isValidH = yourH > 0 ? (yourH === clientQuote.H) : true;

                        // Salva lo status per questa misura
                        masterValidationStatus[yourQuote.tipo] = {
                            L: isValidL,
                            H: isValidH
                        };
                    });

                    // Calcola tutte le posizioni (master + repliche)
                    const allPositions = [position];
                    
                    // Trova le repliche
                    const originalTemplate = templates.find(t => t.pos === template.pos);
                    if (originalTemplate && originalTemplate.repliche) {
                        originalTemplate.repliche.forEach(replicaPos => {
                            const replicaPosition = projectPositions.find(p => p.pos === replicaPos);
                            if (replicaPosition) {
                                allPositions.push(replicaPosition);
                            }
                        });
                    }

                    // SECONDA: Per ogni posizione (master + repliche)
                    allPositions.forEach((pos, posIndex) => {
                        // Controlla spazio per nuova pagina - pi√π conservativo
                        if (yPosition > 220) {
                            doc.addPage();
                            yPosition = 20;
                        }

                        // Spaziatura prima della posizione (se non √® la prima)
                        if (posIndex > 0 || index > 0) {
                            yPosition += 8;
                        }

                        // Titolo posizione con sfondo
                        doc.setFillColor(102, 126, 234);
                        doc.rect(10, yPosition - 4, doc.internal.pageSize.width - 20, 8, 'F');
                        
                        doc.setFontSize(13);
                        doc.setTextColor(255, 255, 255);
                        doc.setFont(undefined, 'bold');
                        let posTitle = pos.pos;
                        if (pos.npz > 1) {
                            posTitle += ` | Numero Pezzi: ${pos.npz}`;
                        }
                        doc.text(posTitle, 12, yPosition);
                        yPosition += 8;

                        // Descrizione prodotto se presente
                        if (template.descrizione && template.descrizione.trim()) {
                            doc.setFontSize(10);
                            doc.setTextColor(...textColor);
                            doc.setFont(undefined, 'bold');
                            const lines = doc.splitTextToSize(template.descrizione, doc.internal.pageSize.width - 24);
                            lines.forEach(line => {
                                doc.text(line, 12, yPosition);
                                yPosition += 4;
                            });
                            doc.setFont(undefined, 'normal');
                            yPosition += 2;
                        }

                        // Note se presenti
                        if (pos.note && pos.note.trim()) {
                            doc.setFontSize(8);
                            doc.setTextColor(...greyColor);
                            doc.setFont(undefined, 'italic');
                            doc.text(`Note: ${pos.note}`, 12, yPosition);
                            doc.setFont(undefined, 'normal');
                            yPosition += 5;
                        }

                        // Ricalcola le quote per QUESTA posizione specifica
                        const posL = parseFloat(pos.l) || 0;
                        const posH = parseFloat(pos.h) || 0;

                        // Prepara dati tabella
                        const tableData = [];

                        template.yourQuotes.forEach((yourQuote, qIndex) => {
                            // Ricalcola le tue misure per QUESTA posizione
                            let yourL = yourQuote.L;
                            let yourH = yourQuote.H;

                            if (yourQuote.L > 0 && refL > 0) {
                                const offsetL = yourQuote.L - refL;
                                yourL = posL + offsetL;
                            }

                            if (yourQuote.H > 0 && refH > 0) {
                                const offsetH = yourQuote.H - refH;
                                yourH = posH + offsetH;
                            }

                            yourL = Math.round(yourL);
                            yourH = Math.round(yourH);

                            // Usa lo status di validazione del MASTER
                            const status = masterValidationStatus[yourQuote.tipo];
                            
                            // Mostra numero se master OK, altrimenti "DA VERIFICARE"
                            const displayL = yourL === 0 ? '-' : (status.L ? yourL.toString() : 'DA VERIFICARE');
                            const displayH = yourH === 0 ? '-' : (status.H ? yourH.toString() : 'DA VERIFICARE');

                            tableData.push([
                                yourQuote.tipo,
                                displayL,
                                displayH
                            ]);
                        });

                        // Genera tabella SEMPLICE (3 colonne)
                        doc.autoTable({
                            startY: yPosition,
                            head: [['Tipo Misura', 'Larghezza (mm)', 'Altezza (mm)']],
                            body: tableData,
                            theme: 'grid',
                            headStyles: {
                                fillColor: [102, 126, 234],
                                textColor: [255, 255, 255],
                                fontSize: 9,
                                fontStyle: 'bold',
                                halign: 'center',
                                cellPadding: 3
                            },
                            bodyStyles: {
                                fontSize: 9,
                                halign: 'center',
                                textColor: textColor,
                                cellPadding: 3
                            },
                            columnStyles: {
                                0: { 
                                    cellWidth: 80, 
                                    halign: 'left',
                                    fontStyle: 'bold'
                                },
                                1: { cellWidth: 45 },
                                2: { cellWidth: 45 }
                            },
                            alternateRowStyles: {
                                fillColor: [248, 249, 250]
                            },
                            didParseCell: function(data) {
                                // Colora in ROSSO le celle "DA VERIFICARE"
                                if (data.section === 'body' && (data.column.index === 1 || data.column.index === 2)) {
                                    const cellValue = data.cell.text[0];
                                    if (cellValue === 'DA VERIFICARE') {
                                        data.cell.styles.textColor = [220, 20, 60];
                                        data.cell.styles.fontStyle = 'bold';
                                        data.cell.styles.fillColor = [255, 240, 240];
                                    }
                                }
                            },
                            margin: { left: 10, right: 10 }
                        });

                        yPosition = doc.lastAutoTable.finalY + 5;
                    });
                });

                // Footer su ogni pagina
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    
                    // Linea separazione footer
                    doc.setDrawColor(...greyColor);
                    doc.setLineWidth(0.3);
                    doc.line(10, doc.internal.pageSize.height - 15, 200, doc.internal.pageSize.height - 15);
                    
                    // Testo footer
                    doc.setFontSize(7);
                    doc.setTextColor(...greyColor);
                    doc.setFont(undefined, 'normal');
                    const footerLeft = `ALPHA SHOWROOM S.A.S. | P.IVA 03289110789`;
                    const footerRight = `Pagina ${i} di ${pageCount}`;
                    const footerCenter = `Generato: ${new Date().toLocaleDateString('it-IT')} ${new Date().toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}`;
                    
                    doc.text(footerLeft, 10, doc.internal.pageSize.height - 10);
                    doc.text(footerCenter, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
                    doc.text(footerRight, 200, doc.internal.pageSize.height - 10, { align: 'right' });
                }

                // Salva PDF
                const fileName = `REPORT_MISURE_${validationData.projectName.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
                doc.save(fileName);

                alert('‚úÖ Report Misure generato con successo!');

            } catch (error) {
                console.error('Errore:', error);
                alert('‚ùå Errore durante la generazione del PDF.\n\nDettagli: ' + error.message);
            }
        }

        function deleteValidation(validationId) {
            const validation = validations.find(v => v.id === validationId);
            if (!validation) return;

            const confirmMsg = validation.status === 'pending' 
                ? `Vuoi eliminare la validazione per "${validation.projectName}"?\n\n‚ö†Ô∏è Il cliente non potr√† pi√π confermare le misure con questo link.`
                : `Vuoi eliminare la validazione confermata per "${validation.projectName}"?\n\n‚ö†Ô∏è Perderai i dati della conferma cliente.`;

            if (!confirm(confirmMsg)) {
                return;
            }

            // Rimuovi dall'array
            const index = validations.findIndex(v => v.id === validationId);
            if (index > -1) {
                validations.splice(index, 1);
                saveValidationsData();
                renderValidations();
                alert('‚úÖ Validazione eliminata con successo!');
            }
        }

        // === AUTO-REFRESH VALIDAZIONI ===
        function startValidationsAutoRefresh() {
            // Clear previous interval
            if (validationCheckInterval) {
                clearInterval(validationCheckInterval);
            }
            
            // Check subito
            checkAllPendingValidations();
            
            // Poi ogni 30 secondi
            validationCheckInterval = setInterval(() => {
                checkAllPendingValidations();
            }, 30000);
        }

        function stopValidationsAutoRefresh() {
            if (validationCheckInterval) {
                clearInterval(validationCheckInterval);
                validationCheckInterval = null;
            }
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('projectDate').valueAsDate = new Date();
            document.getElementById('templatePos').addEventListener('change', updateTemplateRefMisure);
            loadData();
            loadValidationsData();
        });

        // Auto-save progetto
        document.getElementById('projectName').addEventListener('change', saveData);
        document.getElementById('projectDate').addEventListener('change', saveData);
    </script>
</body>
</html>
